---
title: "[SQL 문법] 2. 함수(3) - 그룹화 함수"
excerpt: "0522 SQL 함수(3) - 그룹화 함수"

categories:
  - SQL 문법
tags:
  - []

permalink: /sql_basic/lesson2-3/

toc: true
toc_sticky: ture

date: 2023-05-22
last_modified_at: 2023-05-22
---

## 그룹화 함수
### GROUP BY

`UNION` 집합 연산자를 사용한 그룹화

```sql
SELECT '10' AS DEPTNO, AVG(SAL) FROM EMP WHERE DEPTNO = 10
UNION
SELECT '20' AS DEPTNO, AVG(SAL) FROM EMP WHERE DEPTNO = 20
UNION
SELECT '30' AS DEPTNO, AVG(SAL) FROM EMP WHERE DEPTNO = 30;
```

`GROUP BY`

```sql
SELECT DEPTNO, AVG(SAL) FROM EMP GROUP BY DEPTNO ORDER BY DEPTNO;

-- 2개의 열을 이용
SELECT DEPTNO, JOB, AVG(SAL) FROM EMP 
GROUP BY DEPTNO, JOB
ORDER BY DEPTNO ASC, JOB ASC;
```

`GROUP BY`에 사용하지 않는 열 이름을 SELECT 절에서 사용하게 되면 오류 발생

```sql
SELECT DEPTNO, ENAME, AVG(SAL) FROM EMP 
GROUP BY DEPTNO;
```

***

### HAVING

- 평균 급여 2000이상

```sql
SELECT DEPTNO, JOB, AVG(SAL) FROM EMP 
GROUP BY DEPTNO, JOB HAVING AVG(SAL) >= 2000
ORDER BY DEPTNO ASC, JOB ASC;
```

- 직책이 CLERK인 경우

```sql
SELECT DEPTNO, JOB, AVG(SAL) FROM EMP 
GROUP BY DEPTNO, JOB HAVING JOB = 'CLERK'
ORDER BY DEPTNO ASC, JOB ASC;
```

- WHERE절과 비교

WHERE절로 필터링된 데이터를 그룹화
```sql
SELECT DEPTNO, JOB, AVG(SAL) FROM EMP WHERE SAL >= 2000
GROUP BY DEPTNO, JOB
ORDER BY DEPTNO ASC, JOB ASC;
```

***

### GROUP BY와 함께 사용하는 함수

`ROLLUP(A,B)`: A+B, A, 전체

```sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL) 
FROM EMP
GROUP BY ROLLUP(DEPTNO, JOB);
```

`A ROLLUP(B)`: A+B, B

```sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL) 
FROM EMP
GROUP BY DEPTNO, ROLLUP(JOB);
```

`CUBE`(A,B): A+B, A, B, 전체

```sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL) 
FROM EMP
GROUP BY CUBE(DEPTNO, JOB);
```

`GROUPING SETS(A,B)`: A, B

```sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL) 
FROM EMP
GROUP BY GROUPING SETS(DEPTNO, JOB);
```

`GROUPING`: A+B(0 0), A(0 1), B(1 0), 전체(1 1)

```sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL), 
GROUPING(DEPTNO), GROUPING(JOB), GROUPING_ID(DEPTNO, JOB)
FROM EMP
GROUP BY CUBE(DEPTNO, JOB);
```

`GROUPING_ID`: A+B(0), A(1), B(2), 전체(3)

```sql
SELECT DEPTNO, JOB, COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL), 
GROUPING(DEPTNO), GROUPING(JOB), GROUPING_ID(DEPTNO, JOB)
FROM EMP
GROUP BY CUBE(DEPTNO, JOB);
```

***

### DECODE문으로 비어있는 값(null) 채우기

```sql
-- 비어있는 값 = 그룹화에 사용되지 않음
SELECT 
    DECODE(GROUPING(DEPTNO), 1, 'ALL_DEPT', DEPTNO) AS DEPTNO,
    DECODE(GROUPING(JOB), 1, 'ALL_JOB', JOB) AS JOB,
    COUNT(*), MAX(SAL), SUM(SAL), AVG(SAL) FROM EMP
GROUP BY CUBE(DEPTNO, JOB);
```

***

### LISTAGG
- 부서별로 사원 이름을 **알파벳 순서대로** 나열한 다음 이름과 이름 사이에 ', '로 연결시켜 출력

```sql
SELECT 
	DEPTNO, 
	LISTAGG(ENAME, ', ') WITHIN GROUP(ORDER BY ENAME ASC) AS ENAME
FROM EMP
GROUP BY DEPTNO;
```

- 부서별로 사원 이름을 **급여가 높은 순서대로** 나열한 다음 이름과 이름 사이에 ', '로 연결시켜 출력

```sql
SELECT 
	DEPTNO, 
	LISTAGG(ENAME, ', ') WITHIN GROUP(ORDER BY SAL DESC) AS ENAME
FROM EMP
GROUP BY DEPTNO;
```

***

### PIVOT & UNPIVOT
`PIVOT`: 행을 열로 바꿈  
`UNPIVOT`: 열을 행으로 바꿈

- 부서번호를 행에서 열로 바꿈

```sql
SELECT * FROM (SELECT DEPTNO, JOB, SAL FROM EMP)
    PIVOT (MAX(SAL) FOR DEPTNO IN (10,20,30))
    ORDER BY JOB;
```

- 직책을 행에서 열로 바꿈

```sql
SELECT * FROM (SELECT DEPTNO, JOB, SAL FROM EMP)
    PIVOT (MAX(SAL) FOR JOB IN ('ANALYST' AS ANALYST,
                                'CLERK' AS CLERK,
                                'MANAGER' AS MANGER,
                                'PRESIDENT' AS PRESIDENT,
                                'SALESMAN' AS SALESMAN))
    ORDER BY DEPTNO;
```

- DECODE문으로 PIVOT 테이블 만들기

```sql
SELECT DEPTNO,
    MAX(DECODE(JOB, 'ANALYST', SAL)) AS ANALYST,
    MAX(DECODE(JOB, 'CLERK', SAL)) AS CLERK,
    MAX(DECODE(JOB, 'MANAGER', SAL)) AS MANAGER,
    MAX(DECODE(JOB, 'PRESIDENT', SAL)) AS PRESIDENT,
    MAX(DECODE(JOB, 'SALESMAN', SAL)) AS SALESMAN
FROM EMP
GROUP BY DEPTNO
ORDER BY DEPTNO;
```

- PIVOT 테이블을 다시 UNPIVOT  

```sql
SELECT * FROM (SELECT DEPTNO,
    MAX(DECODE(JOB, 'ANALYST', SAL)) AS ANALYST,
    MAX(DECODE(JOB, 'CLERK', SAL)) AS CLERK,
    MAX(DECODE(JOB, 'MANAGER', SAL)) AS MANAGER,
    MAX(DECODE(JOB, 'PRESIDENT', SAL)) AS PRESIDENT,
    MAX(DECODE(JOB, 'SALESMAN', SAL)) AS SALESMAN
FROM EMP
GROUP BY DEPTNO
ORDER BY DEPTNO)
UNPIVOT (SAL FOR JOB IN (ANALYST, CLERK, MANAGER, PRESIDENT, SALESMAN))
ORDER BY DEPTNO, JOB;
```